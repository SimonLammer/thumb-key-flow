<!DOCTYPE html>
<html lang="en">
<!-- Please do not look at this code, it is truly terrible (but gets the job done) -->
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Typing test</title>
    <style type="text/css">
      #canvas {
        display: inline-block;
        width: 400px;
        height: 400px;
      }
      #out {
        width: 100%;
        height: 100%;
        font-size: 3em;
        margin: 0;
      }
      #in {
        width: 100%;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div>
      <canvas id="canvas" width="1000" height="1000">
      </canvas>
      <p id="out">
        hit space to start
      <p>
    </div>
    <input type="text" id="in"/>
    <p id="stats">
      start typing to get stats
    </p>
    <script type="text/javascript">
      var txt_in = document.getElementById("in");
      var out = document.getElementById("out");
      var p_stats = document.getElementById("stats");
      var canvas = document.getElementById("canvas");
      var ctx = canvas.getContext("2d");
      var characters = ['↖', '↑', '↗', '←', '⏺', '→', '↙', '↓', '↘'];
      var word_length = 2;
      var goal = " ";
      var start_time = null;
      var stats = {"goals":[], "input":"", "transitions": {}, "timings": {}};
      var streak = 0;

      function draw(word) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        part = (canvas.width - 1) / 5;
        ctx.lineWidth = part / 30;
        for (var i = 1; i <= 4; i++) {
          var x = i * part;

          // vertical
          ctx.moveTo(x, part);
          ctx.lineTo(x, canvas.height - part);
          ctx.stroke();

          //horizontal
          ctx.moveTo(part, x);
          ctx.lineTo(canvas.width - part, x);
          ctx.stroke();
        }
        function coords(pos) {
          console.log(pos);
          return [pos % 3 - 1, 1 - Math.floor(pos / 3)];
        }
        var start = coords(characters.indexOf(word[0]));
        var end = coords(characters.indexOf(word[1]));
        console.log(start, end);
        end[0] += start[0];
        end[1] += start[1];
        function canvasCoords(coord) {
          return [canvas.width / 2 + coord[0] * part, canvas.height / 2 - coord[1] * part];
        }
        start = canvasCoords(start);
        end = canvasCoords(end);
        ctx.beginPath();
        ctx.arc(start[0], start[1], part / 4, 0, 2 * Math.PI);
        ctx.fill();
        ctx.lineWidth = part / 10;
        ctx.moveTo(start[0], start[1]);
        ctx.lineTo(end[0], end[1]);
        ctx.stroke();
      }

      function randomElement(array) {
        return array[Math.floor(Math.random() * array.length)];
      }

      var goal_old = "";
      function input(e) {
        console.log(txt_in.value);
        var solved = txt_in.value.endsWith(goal);
        if (start_time != null) {
          var time_delay = new Date() - start_time;
          s = stats["timings"][goal];
          if (s == undefined) {
            s = [];
          }
          if (!solved) {
            time_delay = -time_delay;
          }
          s.push(time_delay);
          stats["timings"][goal] = s;
        }
        if (solved) {
          streak++;
          if (streak > 1) {
            var s = stats["transitions"][[goal_old, goal]];
            if (s == undefined) {
              s = [];
            }
            s.push(time_delay);
            stats["transitions"][[goal_old, goal]] = s;
          }
          goal_old = goal;
          goal = "";
          for (var i = 0; i < word_length; i++) {
            goal += randomElement(characters);
          }
          stats["input"] += txt_in.value;
          stats["goals"].push(goal);
          out.innerText = goal;
          draw(goal);
          txt_in.value = "";
        } else {
          streak = 0;
        }
        p_stats.innerText = (new Date()).toISOString() + "\n" + JSON.stringify(stats);
        start_time = new Date();
      }
      txt_in.addEventListener("input", input);
    </script>
  </body>
</html>
